<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Time Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #f97316;
            --primary-light: #fb923c;
            --primary-dark: #ea580c;
            --primary-gradient: linear-gradient(135deg, #f97316, #fb923c);
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --border-color: #4b5563;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-orange: 0 4px 6px -1px rgba(249, 115, 22, 0.2);
            --achievement-bronze: #cd7f32;
            --achievement-silver: #c0c0c0;
            --achievement-gold: #ffd700;
            --heatmap-0: #161b22;
            --heatmap-1: #4c1d06;
            --heatmap-2: #7c2d12;
            --heatmap-3: #ea580c;
            --heatmap-4: #fb923c;
            --character-size: 120px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 2rem;
        }

        .timer-container {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            text-align: center;
            margin-bottom: 2rem;
            width: 100%;
            max-width: 600px;
            border: 1px solid var(--border-color);
        }

        .timer-display {
            font-size: 4rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            letter-spacing: -0.025em;
            text-shadow: 0 2px 4px rgba(249, 115, 22, 0.2);
        }

        .total-display {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .tag-input {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            width: 100%;
            max-width: 300px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .tag-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }

        button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
            opacity: 0;
            transition: opacity 0.2s;
        }

        button:hover::before {
            opacity: 1;
        }

        #startBtn {
            background: var(--primary-gradient);
            color: white;
        }

        #pauseBtn {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
        }

        #resetBtn {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
        }

        .history-container {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            width: 100%;
            border: 1px solid var(--border-color);
        }

        .history-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background-color: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-orange);
        }

        .tab:hover:not(.active) {
            background-color: var(--bg-secondary);
        }

        .filters {
            background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary));
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .filter-group input[type="date"],
        .filter-group select,
        .filter-group input[type="text"] {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            transition: all 0.2s;
        }

        .filter-group input[type="date"]:focus,
        .filter-group select:focus,
        .filter-group input[type="text"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }

        #applyFilters, #clearFilters {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        #applyFilters {
            background: var(--primary-gradient);
        }

        #clearFilters {
            background-color: var(--danger-color);
        }

        .session-list {
            list-style: none;
            padding: 0;
        }

        .session-item {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: background-color 0.2s;
        }

        .session-item:hover {
            background-color: var(--bg-tertiary);
        }

        .session-tag {
            background: var(--primary-gradient);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: var(--shadow-orange);
        }

        .completed-tasks {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .task-list {
            list-style: none;
            padding-left: 1rem;
            margin-top: 0.5rem;
        }

        .task-list li {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .task-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-weight: bold;
        }

        .todo-container {
            margin-top: 1.5rem;
        }

        .todo-input {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .todo-input input {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .todo-input input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }

        .todo-list {
            list-style: none;
            padding: 0;
        }

        .todo-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            gap: 0.75rem;
            transition: background-color 0.2s;
        }

        .todo-item:hover {
            background-color: var(--bg-tertiary);
        }

        .todo-item.completed {
            opacity: 0.7;
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .todo-text {
            flex: 1;
            font-size: 1rem;
        }

        .todo-delete {
            color: var(--danger-color);
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.25rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .todo-delete:hover {
            opacity: 1;
        }

        .todo-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .chart-container {
            margin-top: 2rem;
            height: 300px;
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .gamification-container {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            width: 100%;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .achievements-container {
            margin-top: 2rem;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .achievement-card {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid var(--border-color);
        }

        .achievement-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .achievement-bronze {
            background: var(--achievement-bronze);
        }

        .achievement-silver {
            background: var(--achievement-silver);
        }

        .achievement-gold {
            background: var(--achievement-gold);
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .achievement-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .achievement-progress {
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            margin-top: 0.5rem;
        }

        .achievement-progress-bar {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .level-indicator {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }

        .level-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--primary-color) 0% var(--progress), var(--bg-tertiary) var(--progress) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .level-inner {
            position: absolute;
            width: 80px;
            height: 80px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .level-number {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .level-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .heatmap-container {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .heatmap-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .heatmap {
            display: grid;
            grid-template-columns: repeat(53, 1fr);
            gap: 3px;
            margin-bottom: 1rem;
        }

        .heatmap-day {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            background-color: var(--heatmap-0);
            transition: background-color 0.2s;
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .legend-colors {
            display: flex;
            gap: 2px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .character-container {
            position: relative;
            width: var(--character-size);
            height: var(--character-size);
            margin: 1rem auto;
            background: var(--bg-tertiary);
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.3);
        }

        .character {
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            transition: all 0.3s ease;
        }

        .character-idle {
            animation: idle 2s infinite ease-in-out;
        }

        .character-active {
            animation: active 1s infinite ease-in-out;
        }

        .character-levelup {
            animation: levelup 1s ease-out;
        }

        @keyframes idle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes active {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes levelup {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .character-title {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 0.5rem;
            text-shadow: 0 2px 4px rgba(249, 115, 22, 0.2);
        }

        .character-description {
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .timer-container {
                padding: 1.5rem;
            }

            .timer-display {
                font-size: 3rem;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group input[type="text"] {
                width: 100%;
            }

            .controls {
                flex-wrap: wrap;
            }

            button {
                flex: 1;
                min-width: 120px;
            }
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .chart-container {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="gamification-container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="character-container">
                        <div class="character" id="character"></div>
                    </div>
                    <div class="character-title" id="characterTitle">Novice Adventurer</div>
                    <div class="character-description" id="characterDescription">Level 1</div>
                    <div class="level-indicator">
                        <div class="level-circle" id="levelCircle">
                            <div class="level-inner">
                                <div class="level-number" id="levelNumber">1</div>
                                <div class="level-label">Level</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalXp">0</div>
                    <div class="stat-label">Total XP</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="achievementsCount">0</div>
                    <div class="stat-label">Achievements</div>
                </div>
            </div>
            <div class="achievements-container">
                <h2 class="history-title">Achievements</h2>
                <div class="achievement-grid" id="achievementGrid"></div>
            </div>
        </div>

        <div class="timer-container">
            <div class="timer-display" id="display">00:00:00</div>
            <div class="total-display">Total: <span id="totalDisplay">00:00:00</span></div>
            <input type="text" class="tag-input" id="tagInput" placeholder="Enter activity tag (e.g., 'Work', 'Study')">
            <div class="controls">
                <button id="startBtn">Start</button>
                <button id="pauseBtn">Pause</button>
                <button id="resetBtn">Reset</button>
            </div>
        </div>

        <div class="history-container">
            <div class="tabs">
                <div class="tab active" data-tab="sessions">Sessions</div>
                <div class="tab" data-tab="analytics">Analytics</div>
                <div class="tab" data-tab="todo">To-Do List</div>
            </div>
            
            <div id="sessionsTab">
                <h2 class="history-title">Session History</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label>Date Range:</label>
                        <input type="date" id="startDate">
                        <span>to</span>
                        <input type="date" id="endDate">
                    </div>
                    <div class="filter-group">
                        <label>Activity Tag:</label>
                        <select id="tagFilter">
                            <option value="">All Activities</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Show Only Sessions With:</label>
                        <input type="text" id="taskFilter" placeholder="Completed tasks containing...">
                    </div>
                    <button id="applyFilters">Apply Filters</button>
                    <button id="clearFilters">Clear Filters</button>
                </div>
                <ul class="session-list" id="sessionList"></ul>
            </div>
            
            <div id="analyticsTab" style="display: none;">
                <h2 class="history-title">Activity Analytics</h2>
                <div class="analytics-grid">
                    <div class="stats-overview">
                        <div class="stat-card">
                            <div class="stat-value" id="avgSessionDuration">0:00:00</div>
                            <div class="stat-label">Average Session Duration</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="bestDay">-</div>
                            <div class="stat-label">Most Productive Day</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalSessions">0</div>
                            <div class="stat-label">Total Sessions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="longestStreak">0</div>
                            <div class="stat-label">Longest Streak (days)</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Activity Distribution by Tag</h3>
                        <canvas id="activityChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Daily Activity Distribution</h3>
                        <canvas id="dailyDistributionChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Productivity Trend (Last 30 Days)</h3>
                        <canvas id="trendChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Session Duration Distribution</h3>
                        <canvas id="durationChart"></canvas>
                    </div>
                    <div class="heatmap-container">
                        <h3 class="heatmap-title">Activity Heatmap</h3>
                        <div class="heatmap" id="activityHeatmap"></div>
                        <div class="heatmap-legend">
                            <span>Less</span>
                            <div class="legend-colors">
                                <div class="legend-color" style="background-color: var(--heatmap-0)"></div>
                                <div class="legend-color" style="background-color: var(--heatmap-1)"></div>
                                <div class="legend-color" style="background-color: var(--heatmap-2)"></div>
                                <div class="legend-color" style="background-color: var(--heatmap-3)"></div>
                                <div class="legend-color" style="background-color: var(--heatmap-4)"></div>
                            </div>
                            <span>More</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="todoTab" style="display: none;">
                <h2 class="history-title">To-Do List</h2>
                <div class="todo-container">
                    <div class="todo-input">
                        <input type="text" id="todoInput" placeholder="Add a new task...">
                        <button id="addTodoBtn">Add</button>
                    </div>
                    <ul class="todo-list" id="todoList"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let timer;
        let hours = 0;
        let minutes = 0;
        let seconds = 0;
        let isRunning = false;
        let totalSeconds = 0;
        let currentSessionStart = null;
        let currentTag = '';

        // Chart instances
        let activityChart = null;
        let dailyDistributionChart = null;
        let trendChart = null;
        let durationChart = null;

        const display = document.getElementById('display');
        const totalDisplay = document.getElementById('totalDisplay');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const tagInput = document.getElementById('tagInput');
        const sessionList = document.getElementById('sessionList');
        const tabs = document.querySelectorAll('.tab');
        const sessionsTab = document.getElementById('sessionsTab');
        const analyticsTab = document.getElementById('analyticsTab');

        // Gamification variables
        let currentLevel = 1;
        let currentXp = 0;
        let currentStreak = 0;
        let lastActivityDate = null;
        const xpPerMinute = 1;
        const xpPerLevel = 1000;

        const achievements = [
            {
                id: 'first_session',
                title: 'First Timer',
                description: 'Complete your first session',
                icon: 'â±ï¸',
                tier: 'bronze',
                progress: 0,
                maxProgress: 1,
                xpReward: 100
            },
            {
                id: 'streak_3',
                title: '3-Day Streak',
                description: 'Maintain a 3-day streak',
                icon: 'ðŸ”¥',
                tier: 'silver',
                progress: 0,
                maxProgress: 3,
                xpReward: 300
            },
            {
                id: 'streak_7',
                title: '7-Day Streak',
                description: 'Maintain a 7-day streak',
                icon: 'ðŸŒŸ',
                tier: 'gold',
                progress: 0,
                maxProgress: 7,
                xpReward: 700
            },
            {
                id: 'streak_30',
                title: '30-Day Streak',
                description: 'Maintain a 30-day streak',
                icon: 'ðŸ†',
                tier: 'platinum',
                progress: 0,
                maxProgress: 30,
                xpReward: 3000
            },
            {
                id: 'total_10_hours',
                title: '10 Hours Club',
                description: 'Track 10 hours of activity',
                icon: 'â°',
                tier: 'bronze',
                progress: 0,
                maxProgress: 600,
                xpReward: 200
            },
            {
                id: 'total_50_hours',
                title: '50 Hours Club',
                description: 'Track 50 hours of activity',
                icon: 'âŒ›',
                tier: 'silver',
                progress: 0,
                maxProgress: 3000,
                xpReward: 1000
            },
            {
                id: 'total_100_hours',
                title: '100 Hours Club',
                description: 'Track 100 hours of activity',
                icon: 'ðŸ†',
                tier: 'gold',
                progress: 0,
                maxProgress: 6000,
                xpReward: 2000
            },
            {
                id: 'early_bird',
                title: 'Early Bird',
                description: 'Start a session before 8 AM',
                icon: 'ðŸŒ…',
                tier: 'bronze',
                progress: 0,
                maxProgress: 1,
                xpReward: 150
            },
            {
                id: 'night_owl',
                title: 'Night Owl',
                description: 'Start a session after 10 PM',
                icon: 'ðŸŒ™',
                tier: 'bronze',
                progress: 0,
                maxProgress: 1,
                xpReward: 150
            },
            {
                id: 'marathon',
                title: 'Marathon',
                description: 'Complete a 4-hour session',
                icon: 'ðŸƒ',
                tier: 'silver',
                progress: 0,
                maxProgress: 1,
                xpReward: 500
            },
            {
                id: 'multitasker',
                title: 'Multitasker',
                description: 'Complete 5 different activities in one day',
                icon: 'ðŸŽ¯',
                tier: 'silver',
                progress: 0,
                maxProgress: 5,
                xpReward: 400
            },
            {
                id: 'weekend_warrior',
                title: 'Weekend Warrior',
                description: 'Track activity on both weekend days',
                icon: 'ðŸŽ®',
                tier: 'bronze',
                progress: 0,
                maxProgress: 1,
                xpReward: 200
            }
        ];

        // Daily challenges
        const dailyChallenges = [
            {
                id: 'morning_session',
                title: 'Morning Boost',
                description: 'Start a session before 9 AM',
                icon: 'â˜€ï¸',
                xpReward: 200,
                completed: false
            },
            {
                id: 'long_session',
                title: 'Endurance Test',
                description: 'Complete a 2-hour session',
                icon: 'â³',
                xpReward: 300,
                completed: false
            },
            {
                id: 'variety',
                title: 'Activity Variety',
                description: 'Track 3 different activities today',
                icon: 'ðŸŽ¯',
                xpReward: 250,
                completed: false
            }
        ];

        // Special rewards
        const specialRewards = [
            {
                id: 'streak_booster',
                title: 'Streak Booster',
                description: 'Double XP for 24 hours',
                icon: 'âš¡',
                cost: 1000,
                active: false,
                duration: 24 * 60 * 60 * 1000 // 24 hours in milliseconds
            },
            {
                id: 'xp_multiplier',
                title: 'XP Multiplier',
                description: '1.5x XP for 12 hours',
                icon: 'âœ¨',
                cost: 500,
                active: false,
                duration: 12 * 60 * 60 * 1000 // 12 hours in milliseconds
            },
            {
                id: 'achievement_boost',
                title: 'Achievement Boost',
                description: 'Double achievement progress for 6 hours',
                icon: 'ðŸŽ¯',
                cost: 300,
                active: false,
                duration: 6 * 60 * 60 * 1000 // 6 hours in milliseconds
            }
        ];

        // Character progression system
        const characterStates = [
            {
                level: 1,
                title: "Novice Adventurer",
                description: "Just starting your journey",
                idle: "ðŸ‘¶",
                active: "ðŸ‘¶",
                idleAnimation: "character-idle"
            },
            {
                level: 5,
                title: "Apprentice Explorer",
                description: "Learning the ropes",
                idle: "ðŸ§™â€â™‚ï¸",
                active: "ðŸ§™â€â™‚ï¸",
                idleAnimation: "character-idle"
            },
            {
                level: 10,
                title: "Seasoned Warrior",
                description: "Battle-hardened and ready",
                idle: "âš”ï¸",
                active: "âš”ï¸",
                idleAnimation: "character-idle"
            },
            {
                level: 15,
                title: "Master Adventurer",
                description: "A legend in the making",
                idle: "ðŸ°",
                active: "ðŸ°",
                idleAnimation: "character-idle"
            },
            {
                level: 20,
                title: "Dungeon Master",
                description: "Ruler of the realm",
                idle: "ðŸ‘‘",
                active: "ðŸ‘‘",
                idleAnimation: "character-idle"
            }
        ];

        // Load sessions from localStorage
        function loadSessions() {
            const savedSessions = localStorage.getItem('sessions');
            return savedSessions ? JSON.parse(savedSessions) : [];
        }

        // Save sessions to localStorage
        function saveSessions(sessions) {
            localStorage.setItem('sessions', JSON.stringify(sessions));
        }

        // Load total time from localStorage
        function loadTotalTime() {
            const savedTotal = localStorage.getItem('totalTime');
            if (savedTotal) {
                totalSeconds = parseInt(savedTotal);
                updateTotalDisplay();
            }
        }

        // Save total time to localStorage
        function saveTotalTime() {
            localStorage.setItem('totalTime', totalSeconds.toString());
        }

        function formatTime(h, m, s) {
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            display.textContent = formatTime(hours, minutes, seconds);
        }

        function updateTotalDisplay() {
            const totalHours = Math.floor(totalSeconds / 3600);
            const totalMinutes = Math.floor((totalSeconds % 3600) / 60);
            const totalSecs = totalSeconds % 60;
            totalDisplay.textContent = formatTime(totalHours, totalMinutes, totalSecs);
        }

        function formatDate(date) {
            return new Date(date).toLocaleString();
        }

        function updateSessionList() {
            const sessions = loadSessions();
            // Sort sessions by date in descending order (newest first)
            const sortedSessions = sessions.sort((a, b) => new Date(b.start) - new Date(a.start));
            sessionList.innerHTML = sortedSessions.map(session => `
                <li class="session-item">
                    <div>
                        <span class="session-tag">${session.tag}</span>
                        <span>${formatDate(session.start)}</span>
                        ${session.completedTasks && session.completedTasks.length > 0 ? `
                            <div class="completed-tasks">
                                <strong>Completed:</strong>
                                <ul class="task-list">
                                    ${session.completedTasks.map(task => `<li>${task}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    <div>${formatTime(session.hours, session.minutes, session.seconds)}</div>
                </li>
            `).join('');
        }

        function updateAnalytics() {
            const sessions = loadSessions();
            const tagData = {};
            const dailyData = {};
            const trendData = {};
            const durationData = {
                '0-15m': 0,
                '15-30m': 0,
                '30-60m': 0,
                '1-2h': 0,
                '2h+': 0
            };
            
            let totalDuration = 0;
            let totalSessions = sessions.length;
            let longestStreak = 0;
            let currentStreak = 0;
            let lastDate = null;
            let bestDay = { date: null, duration: 0 };

            // Process sessions data
            sessions.forEach(session => {
                const duration = (session.hours * 3600) + (session.minutes * 60) + session.seconds;
                totalDuration += duration;

                // Tag distribution
                if (!tagData[session.tag]) {
                    tagData[session.tag] = 0;
                }
                tagData[session.tag] += duration;

                // Daily distribution
                const date = new Date(session.start);
                const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' });
                if (!dailyData[dayOfWeek]) {
                    dailyData[dayOfWeek] = 0;
                }
                dailyData[dayOfWeek] += duration;

                // Trend data (last 30 days)
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                if (date >= thirtyDaysAgo) {
                    const dateStr = date.toISOString().split('T')[0];
                    if (!trendData[dateStr]) {
                        trendData[dateStr] = 0;
                    }
                    trendData[dateStr] += duration;
                }

                // Duration distribution
                const minutes = duration / 60;
                if (minutes <= 15) durationData['0-15m']++;
                else if (minutes <= 30) durationData['15-30m']++;
                else if (minutes <= 60) durationData['30-60m']++;
                else if (minutes <= 120) durationData['1-2h']++;
                else durationData['2h+']++;

                // Best day calculation
                const dayStr = date.toISOString().split('T')[0];
                if (!bestDay.date || duration > bestDay.duration) {
                    bestDay = { date: dayStr, duration };
                }

                // Streak calculation
                const sessionDate = new Date(date);
                sessionDate.setHours(0, 0, 0, 0);
                
                if (!lastDate) {
                    currentStreak = 1;
                } else {
                    const diffTime = sessionDate - lastDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) {
                        currentStreak++;
                    } else if (diffDays > 1) {
                        currentStreak = 1;
                    }
                }
                
                if (currentStreak > longestStreak) {
                    longestStreak = currentStreak;
                }
                
                lastDate = sessionDate;
            });

            // Update statistics
            const avgSessionSeconds = totalSessions > 0 ? Math.floor(totalDuration / totalSessions) : 0;
            const avgSessionHours = Math.floor(avgSessionSeconds / 3600);
            const avgSessionMinutes = Math.floor((avgSessionSeconds % 3600) / 60);
            
            document.getElementById('avgSessionDuration').textContent = 
                formatTime(avgSessionHours, avgSessionMinutes, 0);
            document.getElementById('bestDay').textContent = 
                bestDay.date ? new Date(bestDay.date).toLocaleDateString() : '-';
            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('longestStreak').textContent = longestStreak;

            // Update charts
            updateActivityChart(tagData);
            updateDailyDistributionChart(dailyData);
            updateTrendChart(trendData);
            updateDurationChart(durationData);
            updateHeatmap();
        }

        function updateActivityChart(tagData) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            if (activityChart) {
                activityChart.destroy();
            }

            const labels = Object.keys(tagData);
            const data = labels.map(tag => tagData[tag] / 3600); // Convert to hours

            activityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Hours Spent',
                        data: data,
                        backgroundColor: 'rgba(249, 115, 22, 0.5)',
                        borderColor: 'rgba(249, 115, 22, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Hours'
                            }
                        }
                    }
                }
            });
        }

        function updateDailyDistributionChart(dailyData) {
            const ctx = document.getElementById('dailyDistributionChart').getContext('2d');
            if (dailyDistributionChart) {
                dailyDistributionChart.destroy();
            }

            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const data = days.map(day => (dailyData[day] || 0) / 3600); // Convert to hours

            dailyDistributionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Hours Spent',
                        data: data,
                        borderColor: 'rgba(249, 115, 22, 1)',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Hours'
                            }
                        }
                    }
                }
            });
        }

        function updateTrendChart(trendData) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) {
                trendChart.destroy();
            }

            const dates = Object.keys(trendData).sort();
            const data = dates.map(date => trendData[date] / 3600); // Convert to hours

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(date => new Date(date).toLocaleDateString()),
                    datasets: [{
                        label: 'Daily Hours',
                        data: data,
                        borderColor: 'rgba(249, 115, 22, 1)',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Hours'
                            }
                        }
                    }
                }
            });
        }

        function updateDurationChart(durationData) {
            const ctx = document.getElementById('durationChart').getContext('2d');
            if (durationChart) {
                durationChart.destroy();
            }

            const labels = Object.keys(durationData);
            const data = Object.values(durationData);

            durationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(249, 115, 22, 0.2)',
                            'rgba(249, 115, 22, 0.4)',
                            'rgba(249, 115, 22, 0.6)',
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(249, 115, 22, 1)'
                        ],
                        borderColor: 'rgba(249, 115, 22, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function updateHeatmap() {
            const sessions = loadSessions();
            const heatmap = document.getElementById('activityHeatmap');
            const today = new Date();
            const oneYearAgo = new Date(today);
            oneYearAgo.setFullYear(today.getFullYear() - 1);

            // Create a map of daily activity using UTC dates
            const dailyActivity = new Map();
            sessions.forEach(session => {
                const date = new Date(session.start);
                // Convert to UTC midnight to ensure consistent day boundaries
                const utcDate = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
                const key = utcDate.toISOString().split('T')[0];
                const duration = session.hours * 3600 + session.minutes * 60 + session.seconds;
                dailyActivity.set(key, (dailyActivity.get(key) || 0) + duration);
            });

            // Find the maximum activity for a day
            const maxActivity = Math.max(...dailyActivity.values(), 0);
            const activityLevels = [0, maxActivity * 0.25, maxActivity * 0.5, maxActivity * 0.75, maxActivity];

            // Generate the heatmap using UTC dates
            let heatmapHTML = '';
            let currentDate = new Date(oneYearAgo);
            currentDate.setUTCHours(0, 0, 0, 0);
            
            while (currentDate <= today) {
                const dateKey = currentDate.toISOString().split('T')[0];
                const activity = dailyActivity.get(dateKey) || 0;
                
                // Determine the activity level
                let level = 0;
                for (let i = 0; i < activityLevels.length; i++) {
                    if (activity >= activityLevels[i]) {
                        level = i;
                    }
                }

                // Format the date for display in local timezone
                const localDate = new Date(currentDate);
                const displayDate = localDate.toLocaleDateString();
                const hours = Math.round(activity / 3600 * 100) / 100;

                heatmapHTML += `<div class="heatmap-day" style="background-color: var(--heatmap-${level})" 
                    title="${displayDate}: ${hours} hours"></div>`;
                
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            }

            heatmap.innerHTML = heatmapHTML;
        }

        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                currentSessionStart = new Date();
                currentTag = tagInput.value.trim() || 'Untagged';
                checkDailyChallenges();
                updateCharacter();
                timer = setInterval(() => {
                    seconds++;
                    totalSeconds++;
                    const oldLevel = currentLevel;
                    currentXp += xpPerMinute;
                    
                    // Level up check
                    if (currentXp >= currentLevel * xpPerLevel) {
                        currentLevel++;
                        if (currentLevel > oldLevel) {
                            playLevelUpAnimation();
                        }
                    }
                    
                    if (seconds === 60) {
                        seconds = 0;
                        minutes++;
                    }
                    if (minutes === 60) {
                        minutes = 0;
                        hours++;
                    }
                    updateDisplay();
                    updateTotalDisplay();
                    saveTotalTime();
                    saveGamificationData();
                    updateGamificationUI();
                }, 1000);
            }
        }

        function pauseTimer() {
            if (isRunning) {
                isRunning = false;
                clearInterval(timer);
                updateCharacter();
            }
        }

        function resetTimer() {
            if (hours > 0 || minutes > 0 || seconds > 0) {
                const sessions = loadSessions();
                const completedTasks = loadTodos().filter(todo => todo.completed);
                
                sessions.push({
                    tag: currentTag,
                    start: currentSessionStart,
                    hours,
                    minutes,
                    seconds,
                    completedTasks: completedTasks.map(todo => todo.text)
                });
                saveSessions(sessions);
                updateSessionList();
                updateAnalytics();
                updateStreak();
            }

            pauseTimer();
            hours = 0;
            minutes = 0;
            seconds = 0;
            currentSessionStart = null;
            currentTag = '';
            tagInput.value = '';
            updateDisplay();
        }

        // To-Do List functionality
        const todoInput = document.getElementById('todoInput');
        const addTodoBtn = document.getElementById('addTodoBtn');
        const todoList = document.getElementById('todoList');
        const todoTab = document.getElementById('todoTab');

        // Load todos from localStorage
        function loadTodos() {
            const savedTodos = localStorage.getItem('todos');
            return savedTodos ? JSON.parse(savedTodos) : [];
        }

        // Save todos to localStorage
        function saveTodos(todos) {
            localStorage.setItem('todos', JSON.stringify(todos));
        }

        function updateTodoList() {
            const todos = loadTodos();
            todoList.innerHTML = todos.map((todo, index) => `
                <li class="todo-item ${todo.completed ? 'completed' : ''}">
                    <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} data-index="${index}">
                    <span class="todo-text">${todo.text}</span>
                    <span class="todo-delete" data-index="${index}">Ã—</span>
                </li>
            `).join('');

            // Add event listeners to new elements
            document.querySelectorAll('.todo-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', toggleTodo);
            });
            document.querySelectorAll('.todo-delete').forEach(deleteBtn => {
                deleteBtn.addEventListener('click', deleteTodo);
            });
        }

        function addTodo() {
            const text = todoInput.value.trim();
            if (text) {
                const todos = loadTodos();
                todos.push({ text, completed: false });
                saveTodos(todos);
                updateTodoList();
                todoInput.value = '';
            }
        }

        function toggleTodo(e) {
            const index = parseInt(e.target.dataset.index);
            const todos = loadTodos();
            todos[index].completed = !todos[index].completed;
            saveTodos(todos);
            updateTodoList();
        }

        function deleteTodo(e) {
            const index = parseInt(e.target.dataset.index);
            const todos = loadTodos();
            todos.splice(index, 1);
            saveTodos(todos);
            updateTodoList();
        }

        // Add event listeners for todo functionality
        addTodoBtn.addEventListener('click', addTodo);
        todoInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        // Update tab switching to include todo tab
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                sessionsTab.style.display = 'none';
                analyticsTab.style.display = 'none';
                todoTab.style.display = 'none';
                
                if (tab.dataset.tab === 'sessions') {
                    sessionsTab.style.display = 'block';
                } else if (tab.dataset.tab === 'analytics') {
                    analyticsTab.style.display = 'block';
                } else if (tab.dataset.tab === 'todo') {
                    todoTab.style.display = 'block';
                }
            });
        });

        // Add these variables after other const declarations
        const startDateFilter = document.getElementById('startDate');
        const endDateFilter = document.getElementById('endDate');
        const tagFilter = document.getElementById('tagFilter');
        const taskFilter = document.getElementById('taskFilter');
        const applyFiltersBtn = document.getElementById('applyFilters');
        const clearFiltersBtn = document.getElementById('clearFilters');

        // Add this function after other functions
        function updateTagFilterOptions() {
            const sessions = loadSessions();
            const uniqueTags = [...new Set(sessions.map(session => session.tag))];
            
            tagFilter.innerHTML = `
                <option value="">All Activities</option>
                ${uniqueTags.map(tag => `<option value="${tag}">${tag}</option>`).join('')}
            `;
        }

        function filterSessions() {
            const sessions = loadSessions();
            const startDate = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const endDate = endDateFilter.value ? new Date(endDateFilter.value) : null;
            const selectedTag = tagFilter.value;
            const taskSearch = taskFilter.value.toLowerCase();

            const filteredSessions = sessions.filter(session => {
                const sessionDate = new Date(session.start);
                
                // Date filter
                if (startDate && sessionDate < startDate) return false;
                if (endDate && sessionDate > endDate) return false;
                
                // Tag filter
                if (selectedTag && session.tag !== selectedTag) return false;
                
                // Task filter
                if (taskSearch && (!session.completedTasks || 
                    !session.completedTasks.some(task => 
                        task.toLowerCase().includes(taskSearch)))) {
                    return false;
                }
                
                return true;
            });

            displayFilteredSessions(filteredSessions);
        }

        function displayFilteredSessions(sessions) {
            sessionList.innerHTML = sessions.map(session => `
                <li class="session-item">
                    <div>
                        <span class="session-tag">${session.tag}</span>
                        <span>${formatDate(session.start)}</span>
                        ${session.completedTasks && session.completedTasks.length > 0 ? `
                            <div class="completed-tasks">
                                <strong>Completed:</strong>
                                <ul class="task-list">
                                    ${session.completedTasks.map(task => `<li>${task}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    <div>${formatTime(session.hours, session.minutes, session.seconds)}</div>
                </li>
            `).join('');
        }

        // Add these event listeners before the Initialize section
        applyFiltersBtn.addEventListener('click', filterSessions);
        clearFiltersBtn.addEventListener('click', () => {
            startDateFilter.value = '';
            endDateFilter.value = '';
            tagFilter.value = '';
            taskFilter.value = '';
            filterSessions();
        });

        // Load gamification data from localStorage
        function loadGamificationData() {
            const savedData = localStorage.getItem('gamification');
            if (savedData) {
                const data = JSON.parse(savedData);
                currentLevel = data.level || 1;
                currentXp = data.xp || 0;
                currentStreak = data.streak || 0;
                lastActivityDate = data.lastActivityDate ? new Date(data.lastActivityDate) : null;
                achievements.forEach(achievement => {
                    const savedAchievement = data.achievements?.find(a => a.id === achievement.id);
                    if (savedAchievement) {
                        achievement.progress = savedAchievement.progress;
                    }
                });
            }
            updateGamificationUI();
        }

        // Save gamification data to localStorage
        function saveGamificationData() {
            const data = {
                level: currentLevel,
                xp: currentXp,
                streak: currentStreak,
                lastActivityDate: lastActivityDate,
                achievements: achievements
            };
            localStorage.setItem('gamification', JSON.stringify(data));
        }

        // Update gamification UI
        function updateGamificationUI() {
            // Update character-related elements
            const character = document.getElementById('character');
            const characterTitle = document.getElementById('characterTitle');
            const characterDescription = document.getElementById('characterDescription');
            const levelNumber = document.getElementById('levelNumber');
            const levelCircle = document.getElementById('levelCircle');
            const currentStreakElement = document.getElementById('currentStreak');
            const totalXpElement = document.getElementById('totalXp');
            const achievementsCountElement = document.getElementById('achievementsCount');

            if (character && characterTitle && characterDescription && levelNumber && levelCircle) {
                const levelProgress = (currentXp % xpPerLevel) / xpPerLevel * 100;
                levelCircle.style.setProperty('--progress', `${levelProgress}%`);
                levelNumber.textContent = currentLevel;
                updateCharacter();
            }

            if (currentStreakElement) {
                currentStreakElement.textContent = currentStreak;
            }

            if (totalXpElement) {
                totalXpElement.textContent = currentXp;
            }

            if (achievementsCountElement) {
                achievementsCountElement.textContent = achievements.filter(a => a.progress >= a.maxProgress).length;
            }

            const achievementGrid = document.getElementById('achievementGrid');
            if (achievementGrid) {
                achievementGrid.innerHTML = achievements.map(achievement => `
                    <div class="achievement-card">
                        <div class="achievement-icon achievement-${achievement.tier}">
                            ${achievement.icon}
                        </div>
                        <div class="achievement-info">
                            <div class="achievement-title">${achievement.title}</div>
                            <div class="achievement-desc">${achievement.description}</div>
                            <div class="achievement-progress">
                                <div class="achievement-progress-bar" style="width: ${(achievement.progress / achievement.maxProgress) * 100}%"></div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Add checkDailyChallenges function
        function checkDailyChallenges() {
            const now = new Date();
            const hour = now.getHours();
            const sessions = loadSessions();
            const todaySessions = sessions.filter(session => {
                const sessionDate = new Date(session.start);
                return sessionDate.toDateString() === now.toDateString();
            });
            const uniqueTags = new Set(todaySessions.map(session => session.tag));

            // Morning Boost challenge
            if (hour < 9) {
                const morningChallenge = dailyChallenges.find(c => c.id === 'morning_session');
                if (morningChallenge && !morningChallenge.completed) {
                    morningChallenge.completed = true;
                    currentXp += morningChallenge.xpReward;
                }
            }

            // Endurance Test challenge
            const longSessionChallenge = dailyChallenges.find(c => c.id === 'long_session');
            if (longSessionChallenge && !longSessionChallenge.completed) {
                const hasLongSession = todaySessions.some(session => 
                    session.hours >= 2 || (session.hours === 1 && session.minutes >= 30)
                );
                if (hasLongSession) {
                    longSessionChallenge.completed = true;
                    currentXp += longSessionChallenge.xpReward;
                }
            }

            // Activity Variety challenge
            const varietyChallenge = dailyChallenges.find(c => c.id === 'variety');
            if (varietyChallenge && !varietyChallenge.completed) {
                if (uniqueTags.size >= 3) {
                    varietyChallenge.completed = true;
                    currentXp += varietyChallenge.xpReward;
                }
            }

            saveGamificationData();
            updateGamificationUI();
        }

        // Update streak
        function updateStreak() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (!lastActivityDate) {
                currentStreak = 1;
            } else {
                const lastDate = new Date(lastActivityDate);
                lastDate.setHours(0, 0, 0, 0);
                
                const diffTime = today - lastDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 1) {
                    currentStreak++;
                } else if (diffDays > 1) {
                    currentStreak = 1;
                }
            }

            lastActivityDate = today;
            updateAchievements();
            saveGamificationData();
            updateGamificationUI();
        }

        // Update achievements
        function updateAchievements() {
            // First session achievement
            const firstSessionAchievement = achievements.find(a => a.id === 'first_session');
            if (firstSessionAchievement && loadSessions().length > 0) {
                firstSessionAchievement.progress = 1;
            }

            // Streak achievements
            const streak3Achievement = achievements.find(a => a.id === 'streak_3');
            const streak7Achievement = achievements.find(a => a.id === 'streak_7');
            if (streak3Achievement) streak3Achievement.progress = Math.min(currentStreak, 3);
            if (streak7Achievement) streak7Achievement.progress = Math.min(currentStreak, 7);

            // Total hours achievements
            const totalMinutes = totalSeconds / 60;
            const total10HoursAchievement = achievements.find(a => a.id === 'total_10_hours');
            const total50HoursAchievement = achievements.find(a => a.id === 'total_50_hours');
            const total100HoursAchievement = achievements.find(a => a.id === 'total_100_hours');
            
            if (total10HoursAchievement) total10HoursAchievement.progress = Math.min(totalMinutes, 600);
            if (total50HoursAchievement) total50HoursAchievement.progress = Math.min(totalMinutes, 3000);
            if (total100HoursAchievement) total100HoursAchievement.progress = Math.min(totalMinutes, 6000);
        }

        // Update character
        function updateCharacter() {
            const character = document.getElementById('character');
            const characterTitle = document.getElementById('characterTitle');
            const characterDescription = document.getElementById('characterDescription');
            
            // Find the appropriate character state
            let currentState = characterStates[0];
            for (let i = characterStates.length - 1; i >= 0; i--) {
                if (currentLevel >= characterStates[i].level) {
                    currentState = characterStates[i];
                    break;
                }
            }

            // Update character appearance
            character.textContent = isRunning ? currentState.active : currentState.idle;
            character.className = `character ${isRunning ? 'character-active' : currentState.idleAnimation}`;
            
            // Update character info
            characterTitle.textContent = currentState.title;
            characterDescription.textContent = `${currentState.description} (Level ${currentLevel})`;
        }

        // Add level up animation
        function playLevelUpAnimation() {
            const character = document.getElementById('character');
            character.classList.add('character-levelup');
            setTimeout(() => {
                character.classList.remove('character-levelup');
            }, 1000);
        }

        // Initialize
        loadTotalTime();
        updateSessionList();
        updateAnalytics();
        updateTodoList();
        updateTagFilterOptions();
        startBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        resetBtn.addEventListener('click', resetTimer);
        loadGamificationData();
    </script>
</body>
</html> 